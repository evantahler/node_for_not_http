!function(t,e,n){e[t]=n.call(e),"undefined"!=typeof module&&module.exports?module.exports=e[t]:"function"==typeof define&&define.amd&&define(function(){return e[t]})}("Primus",this,function(){"use strict";function t(){this._events={}}function e(t,e){if(!(t instanceof n)){var o=new Error("Primus#"+e+"'s context should called with a Primus instance");if("function"!=typeof t.listeners||!t.listeners("error").length)throw o;t.emit("error",o)}}function n(e,i){if(!(this instanceof n))return new n(e,i);if("function"!=typeof this.client){var s="The client library has not been compiled correctly, see https://github.com/primus/primus#client-library for more details";return this.critical(new Error(s))}"object"==typeof e?(i=e,e=i.url||i.uri||o):i=i||{};var a=this;i.queueSize="queueSize"in i?i.queueSize:1/0,i.timeout="timeout"in i?i.timeout:1e4,i.reconnect="reconnect"in i?i.reconnect:{},i.ping="ping"in i?i.ping:25e3,i.pong="pong"in i?i.pong:1e4,i.strategy="strategy"in i?i.strategy:[],i.transport="transport"in i?i.transport:{},a.buffer=[],a.writable=!0,a.readable=!0,a.url=a.parse(e||o),a.readyState=n.CLOSED,a.options=i,a.timers={},a.attempt=null,a.socket=null,a.latency=0,a.stamps=0,a.disconnect=!1,a.transport=i.transport,a.transformers={outgoing:[],incoming:[]},"string"==typeof i.strategy&&(i.strategy=i.strategy.split(/\s?\,\s?/g)),!1===i.strategy?i.strategy=[]:i.strategy.length||(i.strategy.push("disconnect","online"),this.authorization||i.strategy.push("timeout")),i.strategy=i.strategy.join(",").toLowerCase(),r||t.call(a),"websockets"in i&&(a.AVOID_WEBSOCKETS=!i.websockets),"network"in i&&(a.NETWORK_EVENTS=i.network),i.manual||(a.timers.open=setTimeout(function(){a.clearTimeout("open").open()},0)),a.initialise(i)}t.prototype.listeners=function(t){return Array.apply(this,this._events[t]||[])},t.prototype.emit=function(t,e,n,o,i,r){if(!this._events||!this._events[t])return!1;var s,a,c=this._events[t],u=c.length,p=arguments.length,f=c[0];if(1===u)switch(f.__EE3_once&&this.removeListener(t,f),p){case 1:f.call(f.__EE3_context||this);break;case 2:f.call(f.__EE3_context||this,e);break;case 3:f.call(f.__EE3_context||this,e,n);break;case 4:f.call(f.__EE3_context||this,e,n,o);break;case 5:f.call(f.__EE3_context||this,e,n,o,i);break;case 6:f.call(f.__EE3_context||this,e,n,o,i,r);break;default:for(a=1,s=new Array(p-1);p>a;a++)s[a-1]=arguments[a];f.apply(f.__EE3_context||this,s)}else{for(a=1,s=new Array(p-1);p>a;a++)s[a-1]=arguments[a];for(a=0;u>a;f=c[++a])f.__EE3_once&&this.removeListener(t,f),f.apply(f.__EE3_context||this,s)}return!0},t.prototype.on=function(t,e,n){return this._events||(this._events={}),this._events[t]||(this._events[t]=[]),e.__EE3_context=n,this._events[t].push(e),this},t.prototype.once=function(t,e,n){return e.__EE3_once=!0,this.on(t,e,n)},t.prototype.removeListener=function(t,e){if(!this._events||!this._events[t])return this;for(var n=this._events[t],o=[],i=0,r=n.length;r>i;i++)e&&n[i]!==e&&o.push(n[i]);return this._events[t]=o.length?o:null,this},t.prototype.removeAllListeners=function(t){return this._events?(t?this._events[t]=null:this._events={},this):this},t.prototype.off=t.prototype.removeListener,t.prototype.addListener=t.prototype.on,t.prototype.setMaxListeners=function(){return this};var o;try{o=location.origin?location.origin:location.protocol+"//"+location.hostname+(location.port?":"+location.port:"")}catch(i){o="http://127.0.0.1"}n.require=function(t){return"function"!=typeof require?void 0:"function"==typeof define&&define.amd?void 0:require(t)};var r,s;try{n.Stream=r=n.require("stream"),s=n.require("url").parse,n.require("util").inherits(n,r)}catch(i){n.Stream=t,n.prototype=new t,s=function(t){var e,n=document.createElement("a"),o={};n.href=t;for(e in n)("string"==typeof n[e]||"number"==typeof n[e])&&(o[e]=n[e]);if(!o.port){var i=(o.href||"").split("/");if(i.length>2){var r=i[2],s=r.lastIndexOf("@");~s&&(r=r.slice(s+1)),i=r.split(":"),2===i.length&&(o.port=i[1])}}if(":"===o.protocol&&(o.protocol=o.href.substr(0,o.href.indexOf(":")+1)),"0"===o.port&&(o.port=""),~o.href.indexOf("@")&&!o.auth){var a=o.protocol.length+2;o.auth=o.href.slice(a,o.href.indexOf(o.pathname,a)).split("@")[0]}return o}}n.OPENING=1,n.CLOSED=2,n.OPEN=3,n.prototype.AVOID_WEBSOCKETS=!1,n.prototype.NETWORK_EVENTS=!1,n.prototype.online=!0;try{(n.prototype.NETWORK_EVENTS="onLine"in navigator&&(window.addEventListener||document.body.attachEvent))&&(navigator.onLine||(n.prototype.online=!1))}catch(i){}if(n.prototype.ark={},n.prototype.plugin=function(t){if(e(this,"plugin"),t)return this.ark[t];var n={};for(t in this.ark)n[t]=this.ark[t];return n},n.prototype.reserved=function(t){return/^(incoming|outgoing)::/.test(t)||t in this.reserved.events},n.prototype.reserved.events={readyStateChange:1,reconnecting:1,reconnect:1,offline:1,timeout:1,online:1,error:1,close:1,open:1,data:1,end:1},n.prototype.initialise=function(t){function e(){r.online&&(r.online=!1,r.emit("offline"),r.end())}function o(){r.online||(r.online=!0,r.emit("online"),~r.options.strategy.indexOf("online")&&r.reconnect())}var i,r=this;r.on("outgoing::open",function(){var t=r.readyState;r.readyState=n.OPENING,t!==r.readyState&&r.emit("readyStateChange","opening"),i=+new Date}),r.on("incoming::open",function(){r.attempt&&(r.attempt=null),r.writable=!0,r.readable=!0;var t=r.readyState;if(r.readyState=n.OPEN,t!==r.readyState&&r.emit("readyStateChange","open"),r.latency=+new Date-i,r.emit("open"),r.clearTimeout("ping","pong").heartbeat(),r.buffer.length){for(var e=0,o=r.buffer.length;o>e;e++)r._write(r.buffer[e]);r.buffer=[]}}),r.on("incoming::pong",function(t){r.online=!0,r.clearTimeout("pong").heartbeat(),r.latency=+new Date-t}),r.on("incoming::error",function(t){var e=r.timers.connect;return r.attempt?r.reconnect():(r.listeners("error").length&&r.emit("error",t),void(e&&(~r.options.strategy.indexOf("timeout")?r.reconnect():r.end())))}),r.on("incoming::data",function(t){r.decoder(t,function(e,n){return e?r.listeners("error").length&&r.emit("error",e):void(r.protocol(n)||r.transforms(r,r,"incoming",n,t))})}),r.on("incoming::end",function(){var t=r.readyState;if(r.disconnect)return r.disconnect=!1,r.end();if(r.readyState=n.CLOSED,t!==r.readyState&&r.emit("readyStateChange","end"),r.timers.connect&&r.end(),t===n.OPEN){this.writable=!1,this.readable=!1;for(var e in this.timers)this.clearTimeout(e);if(r.emit("close"),~r.options.strategy.indexOf("disconnect"))return r.reconnect();r.emit("outgoing::end"),r.emit("end")}}),r.client();for(var s in r.ark)r.ark[s].call(r,r,t);return r.NETWORK_EVENTS?(window.addEventListener?(window.addEventListener("offline",e,!1),window.addEventListener("online",o,!1)):document.body.attachEvent&&(document.body.attachEvent("onoffline",e),document.body.attachEvent("ononline",o)),r):r},n.prototype.protocol=function(t){if("string"!=typeof t||0!==t.indexOf("primus::"))return!1;var e=t.indexOf(":",8),n=t.slice(e+2);switch(t.slice(8,e)){case"pong":this.emit("incoming::pong",n);break;case"server":"close"===n&&(this.disconnect=!0);break;case"id":this.emit("incoming::id",n);break;default:return!1}return!0},n.prototype.transforms=function(t,e,n,o,i){var r={data:o},s=t.transformers[n];return function a(t,n){var o=s[t++];if(!o)return n();if(1===o.length){if(!1===o.call(e,r))return;return a(t,n)}o.call(e,r,function(o,i){return o?e.emit("error",o):void(!1!==i&&a(t,n))})}(0,function(){return"incoming"===n?e.emit("data",r.data,i):void e._write(r.data)}),this},n.prototype.id=function(t){return this.socket&&this.socket.id?t(this.socket.id):(this.write("primus::id::"),this.once("incoming::id",t))},n.prototype.open=function(){return e(this,"open"),!this.attempt&&this.options.timeout&&this.timeout(),this.emit("outgoing::open")},n.prototype.write=function(t){return e(this,"write"),this.transforms(this,this,"outgoing",t),!0},n.prototype._write=function(t){var e=this;return n.OPEN!==e.readyState?(this.buffer.length===this.options.queueSize&&this.buffer.splice(0,1),this.buffer.push(t),!1):(e.encoder(t,function(t,n){return t?e.listeners("error").length&&e.emit("error",t):void e.emit("outgoing::data",n)}),!0)},n.prototype.heartbeat=function(){function t(){n.clearTimeout("pong"),n.online&&(n.online=!1,n.emit("offline"),n.emit("incoming::end"))}function e(){n.clearTimeout("ping").write("primus::ping::"+ +new Date),n.emit("outgoing::ping"),n.timers.pong=setTimeout(t,n.options.pong)}var n=this;return n.options.ping?void(n.timers.ping=setTimeout(e,n.options.ping)):n},n.prototype.timeout=function(){function t(){e.removeListener("error",t).removeListener("open",t).removeListener("end",t).clearTimeout("connect")}var e=this;return e.timers.connect=setTimeout(function(){t(),e.readyState===n.OPEN||e.attempt||(e.emit("timeout"),~e.options.strategy.indexOf("timeout")?e.reconnect():e.end())},e.options.timeout),e.on("error",t).on("open",t).on("end",t)},n.prototype.clearTimeout=function(){for(var t=arguments,e=0,n=t.length;n>e;e++)this.timers[t[e]]&&clearTimeout(this.timers[t[e]]),delete this.timers[t[e]];return this},n.prototype.backoff=function(t,e){e=e||{};var n=this;return e.backoff?n:(e.maxDelay="maxDelay"in e?e.maxDelay:1/0,e.minDelay="minDelay"in e?e.minDelay:500,e.retries="retries"in e?e.retries:10,e.attempt=(+e.attempt||0)+1,e.factor="factor"in e?e.factor:2,e.attempt>e.retries?(t(new Error("Unable to retry"),e),n):(e.backoff=!0,e.timeout=1!==e.attempt?Math.min(Math.round((Math.random()+1)*e.minDelay*Math.pow(e.factor,e.attempt)),e.maxDelay):e.minDelay,n.timers.reconnect=setTimeout(function(){e.backoff=!1,n.clearTimeout("reconnect"),t(void 0,e)},e.timeout),n.emit("reconnecting",e),n))},n.prototype.reconnect=function(){var t=this;return t.attempt=t.attempt||t.clone(t.options.reconnect),t.backoff(function(e,n){return e?(t.attempt=null,t.emit("end")):(t.emit("reconnect",n),void t.emit("outgoing::reconnect"))},t.attempt),t},n.prototype.end=function(t){if(e(this,"end"),this.readyState===n.CLOSED&&!this.timers.connect)return this.timers.reconnect&&(this.clearTimeout("reconnect"),this.attempt=null,this.emit("end")),this;t&&this.write(t),this.writable=!1,this.readable=!1;var o=this.readyState;this.readyState=n.CLOSED,o!==this.readyState&&this.emit("readyStateChange","end");for(var i in this.timers)this.clearTimeout(i);return this.emit("outgoing::end"),this.emit("close"),this.emit("end"),this},n.prototype.clone=function(t){return this.merge({},t)},n.prototype.merge=function(t){for(var e,n,o=Array.prototype.slice.call(arguments,1),i=0,r=o.length;r>i;i++){n=o[i];for(e in n)n.hasOwnProperty(e)&&(t[e]=n[e])}return t},n.prototype.parse=s,n.prototype.querystring=function(t){for(var e,n=/([^=?&]+)=([^&]*)/g,o={};e=n.exec(t);o[decodeURIComponent(e[1])]=decodeURIComponent(e[2]));return o},n.prototype.querystringify=function(t){var e=[];for(var n in t)t.hasOwnProperty(n)&&e.push(encodeURIComponent(n)+"="+encodeURIComponent(t[n]));return e.join("&")},n.prototype.uri=function(t){var e=this.url,n=[],o=!1;t.query&&(o=!0),t=t||{},t.protocol="protocol"in t?t.protocol:"http",t.query=e.search&&"query"in t?"?"===e.search.charAt(0)?e.search.slice(1):e.search:!1,t.secure="secure"in t?t.secure:"https:"===e.protocol||"wss:"===e.protocol,t.auth="auth"in t?t.auth:e.auth,t.pathname="pathname"in t?t.pathname:this.pathname.slice(1),t.port="port"in t?+t.port:+e.port||(t.secure?443:80),t.host="host"in t?t.host:e.hostname||e.host.replace(":"+e.port,""),this.emit("outgoing::url",t);var i=443!==t.port&&80!==t.port?t.host+":"+t.port:t.host,r=this.querystring(t.query||"");return r._primuscb=+new Date+"-"+this.stamps++,t.query=this.querystringify(r),n.push(t.secure?t.protocol+"s:":t.protocol+":",""),n.push(t.auth?t.auth+"@"+i:i),t.pathname&&n.push(t.pathname),o?n.push("?"+t.query):delete t.query,t.object?t:n.join("/")},n.prototype.emits=function(t,e){var n=this;return function(o){var i=e?e.apply(n,arguments):o;setTimeout(function(){n.emit("incoming::"+t,i)},0)}},n.prototype.transform=function(t,n){return e(this,"transform"),t in this.transformers?(this.transformers[t].push(n),this):this.critical(new Error("Invalid transformer type"))},n.prototype.critical=function(t){if(this.listeners("error").length)return this.emit("error",t),this;throw t},n.connect=function(t,e){return new n(t,e)},n.EventEmitter=t,n.prototype.client=function(){var t,e=this,o=function(){if("undefined"!=typeof WebSocket)return WebSocket;if("undefined"!=typeof MozWebSocket)return MozWebSocket;try{return n.require("ws")}catch(t){}return void 0}();return o?(e.on("outgoing::open",function(){e.emit("outgoing::end");try{var n="ws+unix:"===e.url.protocol?"ws+unix":"ws",i="ws"===n;e.socket=t=3===o.length?new o(e.uri({protocol:n,query:i}),[],e.transport):new o(e.uri({protocol:n,query:i}))}catch(r){return e.emit("error",r)}t.binaryType="arraybuffer",t.onopen=e.emits("open"),t.onerror=e.emits("error"),t.onclose=e.emits("end"),t.onmessage=e.emits("data",function(t){return t.data})}),e.on("outgoing::data",function(n){if(t&&t.readyState===o.OPEN)try{t.send(n)}catch(i){e.emit("incoming::error",i)}}),e.on("outgoing::reconnect",function(){e.emit("outgoing::end"),e.emit("outgoing::open")}),void e.on("outgoing::end",function(){t&&(t.onerror=t.onopen=t.onclose=t.onmessage=function(){},t.close(),t=null)})):e.critical(new Error("Missing required `ws` module. Please run `npm install --save ws`"))},n.prototype.authorization=!1,n.prototype.pathname="/primus",n.prototype.encoder=function(t,e){var n;try{t=JSON.stringify(t)}catch(o){n=o}e(n,t)},n.prototype.decoder=function(t,e){var n;if("string"!=typeof t)return e(n,t);try{t=JSON.parse(t)}catch(o){n=o}e(n,t)},n.prototype.version="2.3.0","object"==typeof JSON&&"function"==typeof JSON.stringify&&'["\u2028\u2029"]'===JSON.stringify(["\u2028\u2029"])&&(JSON.stringify=function(t){var e=/\u2028/g,n=/\u2029/g;return function(o,i,r){var s=t.call(this,o,i,r);return s&&(~s.indexOf("\u2028")&&(s=s.replace(e,"\\u2028")),~s.indexOf("\u2029")&&(s=s.replace(n,"\\u2029"))),s}}(JSON.stringify)),"undefined"!=typeof document&&"undefined"!=typeof navigator){document.addEventListener&&document.addEventListener("keydown",function(t){27===t.keyCode&&t.preventDefault&&t.preventDefault()},!1);var a=(navigator.userAgent||"").toLowerCase(),c=a.match(/.+(?:rv|it|ra|ie)[\/: ](\d+)\.(\d+)(?:\.(\d+))?/)||[],u=+[c[1],c[2]].join(".");!~a.indexOf("chrome")&&~a.indexOf("safari")&&534.54>u&&(n.prototype.AVOID_WEBSOCKETS=!0)}return n}),function(t){var e=function(t,e){var n=this;n.callbacks={},n.id=null,n.events={},n.rooms=[],n.state="disconnected",n.options=n.defaults();for(var o in t)n.options[o]=t[o];null!=e&&(n.client=e)};e.prototype="undefined"==typeof Primus?new EventEmitter:new Primus.EventEmitter,e.prototype.defaults=function(){return{apiPath:"/api"}},e.prototype.connect=function(t){var e=this;null==e.client?e.client=Primus.connect(window.location.origin,e.options):(e.client.end(),e.client.open()),e.client.on("open",function(){e.configure(function(n){e.emit("connected"),"connected"===e.state||(e.state="connected","function"==typeof t&&t(null,n))})}),e.client.on("reconnecting",function(){e.state="reconnecting",e.emit("disconnected")}),e.client.on("end",function(){"disconnected"!==e.state&&(e.state="disconnected",e.emit("disconnected"))}),e.client.on("data",function(t){e.handleMessage(t)})},e.prototype.configure=function(t){var e=this;e.messageCount=0,e.detailsView(function(n){e.id=n.data.id,e.rooms.length>0&&e.rooms.forEach(function(t){e.send({event:"roomAdd",room:t})}),t(n)})},e.prototype.send=function(t,e){var n=this;n.messageCount++,"function"==typeof e&&(n.callbacks[n.messageCount]=e),n.client.write(t)},e.prototype.handleMessage=function(t){var e=this;e.emit("message",t),"response"===t.context?("function"==typeof e.callbacks[t.messageCount]&&e.callbacks[t.messageCount](t),delete e.callbacks[t.messageCount]):"user"===t.context?e.emit("say",t):"alert"===t.context?e.emit("alert",t):null!=t.welcome&&"api"==t.context?(e.welcomeMessage=t.welcome,e.emit("welcome",t)):"api"===t.context&&e.emit("api",t)},e.prototype.action=function(t,e,n){null==n&&"function"==typeof e&&(n=e,e=null),null==e&&(e={}),e.action=t,"connected"!==this.state?this.actionWeb(e,n):this.actionWebSocket(e,n)},e.prototype.actionWeb=function(t,e){var n=new XMLHttpRequest;n.onreadystatechange=function(){if(4==n.readyState)if(200==n.status){var t=JSON.parse(n.responseText);e(null,t)}else e(n.statusText,n.responseText)};var o="?";for(var i in t)o+=i+"="+t[i]+"&";var r="GET";null!=t.httpMethod&&(r=t.httpMethod);var s=window.location.origin+this.options.apiPath+o;n.open(r,s,!0),n.send()},e.prototype.actionWebSocket=function(t,e){this.send({event:"action",params:t},e)},e.prototype.say=function(t,e,n){this.send({event:"say",room:t,message:e},n)},e.prototype.file=function(t,e){this.send({event:"file",file:t},e)},e.prototype.detailsView=function(t){this.send({event:"detailsView"},t)},e.prototype.roomView=function(t,e){this.send({event:"roomView",room:t},e)},e.prototype.roomAdd=function(t,e){this.rooms.push(t),this.send({event:"roomAdd",room:t},e)},e.prototype.roomLeave=function(t,e){this.send({event:"roomLeave",room:t},e)},e.prototype.documentation=function(t){this.send({event:"documentation"},t)},e.prototype.disconnect=function(){this.state="disconnected",this.client.end(),this.emit("disconnected")},t.actionheroClient=e}("undefined"==typeof exports?window:exports);